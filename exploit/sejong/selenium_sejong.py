from selenium import webdriver
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.common.exceptions import TimeoutException
from webdriver_manager.chrome import ChromeDriverManager
import re

def init_driver() -> webdriver.Chrome:
    """
    Chrome 드라이버를 초기화하고 반환한다.
    - headless=False (브라우저 표시)
    - detach 옵션으로 스크립트 종료 후에도 브라우저 유지
    """
    options = Options()
    options.headless = False
    options.add_experimental_option("detach", True)
    options.add_argument("--start-maximized")
    service = Service(ChromeDriverManager().install())
    driver = webdriver.Chrome(service=service, options=options)
    driver.implicitly_wait(2)
    return driver


def Maps_to(driver: webdriver.Chrome, url: str, timeout: int = 15) -> bool:
    """
    주어진 URL로 이동한 뒤 DOM 로딩을 대기한다.
    오류 시 False 반환.
    """
    try:
        driver.get(url)
        WebDriverWait(driver, timeout).until(
            lambda d: d.execute_script("return document.readyState") == "complete"
        )
        return True
    except TimeoutException:
        print(f"[Maps_to] 로딩 시간 초과: {url}")
    except Exception as exc:  # pylint: disable=broad-except
        print(f"[Maps_to] 이동 중 오류 발생: {exc}")
    return False


if __name__ == "__main__":
    main_url = "https://classic.sejong.ac.kr/classic/index.do"
    after_login_url = "https://classicad.sejong.ac.kr/sso_login.jsp"
    test_url = "https://classicad.sejong.ac.kr/viewQuestion.do?opAppInfoId="

    driver = init_driver()

    if not Maps_to(driver, main_url):
        raise SystemExit("초기 페이지 로딩 실패")

    # TODO: 아래 위치에 ID/PW 입력 및 로그인 버튼 클릭 코드를 작성하세요.
    # 예시)
    # user_input = WebDriverWait(driver, 10).until(EC.element_to_be_clickable((By.ID, "userId")))
    # pw_input = driver.find_element(By.ID, "userPwd")
    # user_input.send_keys("YOUR_ID")
    # pw_input.send_keys("YOUR_PASSWORD")
    # driver.find_element(By.CSS_SELECTOR, "button.login").click()

    input("로그인/인증을 완료한 뒤 Enter 키를 누르세요... ")

    if Maps_to(driver, after_login_url):
        try:
            WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.TAG_NAME, "body")))
            print("목표 페이지로 이동 완료")
            btn = driver.find_element(By.CSS_SELECTOR, "button.btn.btn-warning[onclick^=\"cancelApp\"]")
            onclick = btn.get_attribute("onclick")
            print("onclick 속성:", onclick)
            value = onclick.split("'")[1]
            print("추출한 값:", value)
            # m = re.search(r"cancelApp\\('([^']+)'\\)", onclick)
            # value = m.group(1) if m else None
        except TimeoutException:
            print("목표 페이지 로딩 대기 중 시간 초과")

    print("url 이동 : ",test_url + value)
    if Maps_to(driver, test_url + value):
        try:
            WebDriverWait(driver, 10).until(EC.presence_of_element_located((By.TAG_NAME, "body")))
            print("목표 페이지로 이동 완료")
            btn = driver.find_element(By.CSS_SELECTOR, "button.btn.btn-warning[onclick^=\"cancelApp\"]")
            onclick = btn.get_attribute("onclick")
            print("onclick 속성:", onclick)
            value = onclick.split("'")[1]
            print("추출한 값:", value)
            # m = re.search(r"cancelApp\\('([^']+)'\\)", onclick)
            # value = m.group(1) if m else None
        except TimeoutException:
            print("목표 페이지 로딩 대기 중 시간 초과")
        
        