import os
import requests
from bs4 import BeautifulSoup

# 환경변수로 ID/PW 설정 권장
USER = os.getenv("SEJONG_ID", "21011739")
PW   = os.getenv("SEJONG_PW", "20010621")

# 로그인 관련 URL들
login_page_url = "https://portal.sejong.ac.kr/jsp/login/loginSSL.jsp"  # GET to fetch form
login_action_url = "https://portal.sejong.ac.kr/jsp/login/login_action.jsp"  # POST target

# 최종 이동하고 싶은 URL (로그인 후 접근할 페이지)
target_url = "https://portal.sejong.ac.kr/comm/member/user/ssoLoginProc.do"  # 예시, 실제로 바꿔야 함

headers = {
    "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) "
                  "AppleWebKit/537.36 (KHTML, like Gecko) Chrome/142.0.0.0 Safari/537.36",
    "Referer": "https://portal.sejong.ac.kr/jsp/login/loginSSL.jsp",
    "Origin": "https://portal.sejong.ac.kr",
}

def parse_hidden_inputs(html_text):
    soup = BeautifulSoup(html_text, "html.parser")
    data = {}
    for inp in soup.find_all("input", {"type": ["hidden", "text", "password"]}):
        name = inp.get("name")
        if not name:
            continue
        value = inp.get("value", "")
        data[name] = value
    return data

with requests.Session() as s:
    s.headers.update({"User-Agent": headers["User-Agent"]})
    # 1) GET login page to get cookies and hidden tokens
    r = s.get(login_page_url, headers={"Referer": "https://portal.sejong.ac.kr"}, timeout=15)
    if r.status_code != 200:
        print("Failed to GET login page:", r.status_code)
        print(r.text[:500])
        raise SystemExit(1)

    # 2) parse hidden inputs (CSRF tokens, etc.)
    formdata = parse_hidden_inputs(r.text)

    # 3) fill in ID/PW into correct field names — replace keys below with real input names
    #    확인: 브라우저에서 form의 <input name="..."> 값을 확인해서 아래 키를 바꾸세요.
    formdata.update({
        "mainLogin": "Y",  # if needed
        "id": USER,        # 실제 아이디 필드 이름으로 바꿀 것
        "password": PW,    # 실제 비밀번호 필드 이름으로 바꿀 것
        "rtUrl": "portal.sejong.ac.kr/comm/member/user/ssoLoginProc.do",  # 예시
    })

    # 4) POST login
    resp = s.post(login_action_url, data=formdata, headers=headers, allow_redirects=True, timeout=15)

    print("POST status:", resp.status_code)
    # 5) 로그인 성공 확인 로직 — 사이트에 맞춰 변경
    if "로그인성공후확인문구" in resp.text or resp.url != login_action_url:
        print("로그인 성공 (heuristic)")
    else:
        print("로그인 실패 (응답 일부):")
        print(resp.url)
        print(resp.text[:1200])

    # 6) 로그인 후 target URL 접근
    r2 = s.get(target_url, headers={"Referer": login_action_url}, timeout=15)
    print("target status:", r2.status_code)
    print(r2.text[:2000])